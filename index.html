<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Street Number Memory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f7f7f9;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --accent: #2563eb;
      --wrong: #dc2626;
      --correct: #16a34a;
      --border: #e5e7eb;
      --overlay: rgba(0,0,0,0.45);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow-x: hidden;
    }

    .app {
      width: 100%;
      max-width: 720px;
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      padding: 24px 28px 32px;
      position: relative;
    }

    h1 { margin: 0 0 8px; font-size: 1.4rem; }

    .subtitle {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 20px;
    }

    .setup-area { display: block; }
    .setup-area.hidden { display: none; }

    .upload {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .settings-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 16px;
      margin-bottom: 6px;
    }

    .mode-selection {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      padding: 4px;
      background: #f3f4f6;
      border-radius: 8px;
      width: fit-content;
    }

    .mode-btn {
      padding: 6px 12px;
      font-size: 0.85rem;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      color: var(--muted);
    }

    .mode-btn.active {
      background: #fff;
      color: var(--accent);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      font-weight: 600;
    }

    .action-row {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    #startBtn, #stopBtn {
      flex: 1;
    }

    #stopBtn { display: none; background: #fee2e2; color: #991b1b; border-color: #fecaca; }

    @media (max-width: 600px) {
      .upload {
        flex-direction: column;
        align-items: stretch;
      }
    }

    input[type=file] { flex: 1; min-width: 200px; }

    button {
      appearance: none;
      border: 1px solid var(--border);
      background: var(--card);
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    button.primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    button.secondary { background: #f3f4f6; }

    button.browse-like {
      font-family: Arial;
      background: #e9e9ed;
      border: 1px solid #8f8f9d;
      border-radius: 4px;
      padding: 4px 5px;
      font-size: 0.76rem;
      font-weight: 500;
      letter-spacing: 0.025em;
      text-rendering: optimizeLegibility;
      line-height: 1;
    }

    button.browse-like:hover {
      background: #d4d4da;
      border-color: #7f7f8d;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status { margin-Bottom: 12px; font-size: 0.85rem; height: 1.2rem; }

    .game { display: none; margin-top: 24px; position: relative; }

    .street-container {
      height: 40px;
      margin-bottom: 20px;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .street {
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
      white-space: nowrap;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .street.moving {
      animation: linearOscillate 9s linear infinite;
    }

    @keyframes linearOscillate {
      0% { left: 50%; transform: translateX(-50%); }
      25% { left: 90%; transform: translateX(-100%); }
      50% { left: 50%; transform: translateX(-50%); }
      75% { left: 10%; transform: translateX(0%); }
      100% { left: 50%; transform: translateX(-50%); }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 12px;
    }

    .grid button {
      height: 56px;
      font-size: 1rem;
      position: relative;
    }

    .grid button.wrong::after,
    .grid button.correct::after {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      border-radius: 8px;
      background: rgba(255,255,255,0.5);
    }

    .grid button.wrong::after { content: '‚úï'; color: var(--wrong); }
    .grid button.correct::after { content: '‚úì'; color: var(--correct); }

    .grid button.highlight {
      border-color: var(--correct);
      box-shadow: 0 0 0 2px rgba(22,163,74,0.2);
    }

    .footer {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: var(--overlay);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal {
      background: var(--card);
      border-radius: 12px;
      width: 95%;
      max-width: 620px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
    }

    .modal-header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-columns {
      display: flex;
      background: #f9fafb;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .col-header {
      flex: 1;
      padding: 10px 16px;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .col-header:hover { background: #f3f4f6; }

    .sort-icon { font-size: 0.7rem; color: var(--muted); width: 10px; }

    .modal-content {
      padding: 0;
      overflow-y: auto;
      font-size: 0.9rem;
      flex: 1;
    }

    /* Error Table Styles */
    .error-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .error-table th {
      text-align: left;
      background: #f9fafb;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      font-size: 0.75rem;
    }
    .error-table td {
      padding: 10px 16px;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: top;
    }
    .error-table tr:hover { background: #fcfcfc; }
    .badge-wrong {
      display: inline-block;
      background: #fee2e2;
      color: #991b1b;
      padding: 2px 6px;
      border-radius: 4px;
      margin-right: 4px;
      margin-bottom: 4px;
      font-weight: 500;
    }
    .text-success { color: var(--correct); font-weight: 600; }
    .text-fail { color: var(--wrong); font-weight: 600; }

    .pair-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 16px;
      border-bottom: 1px solid #f3f4f6;
      border-top: 2px solid transparent;
      align-items: center;
      gap: 10px;
      transition: background-color 0.2s, border-color 0.1s;
      position: relative;
    }

    .pair-row.dragging {
      opacity: 0.5;
      background: #eff6ff;
    }

    .pair-row.drag-over-top { border-top-color: var(--accent); }
    .pair-row.drag-over-bottom { border-bottom-color: var(--accent); }

    .pair-row span { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    
    .pair-row input {
      flex: 1;
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.9rem;
      width: 100%;
    }

    .pair-row:nth-child(even) { background: #f9fafb; }
    
    .modal-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: none;
      justify-content: space-between;
      align-items: center;
      background: #fff;
    }

    .modal-footer.visible { display: flex; }

    .close { cursor: pointer; font-size: 1.1rem; color: var(--muted); padding: 4px; }
    
    .icon-btn {
      background: none;
      border: none;
      padding: 6px;
      cursor: pointer;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }
    .icon-btn:hover { background: #f3f4f6; color: var(--accent); }
    .icon-btn.active { color: var(--accent); background: #eff6ff; }
    .icon-btn.delete { color: var(--wrong); }
    .icon-btn.delete:hover { background: #fee2e2; }
    
    .drag-handle {
      cursor: grab;
      color: #cbd5e1;
      padding: 4px;
    }
    .drag-handle:active { cursor: grabbing; }

    /* Summary Panel Styling */
    .summary-panel {
      display: none;
      text-align: center;
      padding: 20px 0;
    }

    .summary-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .summary-tier {
      font-size: 1.1rem;
      font-weight: 600;
      background: #eff6ff;
      color: var(--accent);
      padding: 12px 20px;
      border-radius: 12px;
      display: inline-block;
      margin-bottom: 24px;
      line-height: 1.4;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #f9fafb;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .stat-val {
      font-size: 1.4rem;
      font-weight: 700;
      display: block;
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .summary-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

  </style>
</head>
<body>
  <div class="app">
    <h1>Street Number Memory</h1>
    
    <div id="setupArea" class="setup-area">
      <div class="subtitle">Match street names to their round numbers.</div>

      <div class="upload">
        <button id="generateBtn" class="browse-like">Random...</button>
        <input type="file" id="fileInput" accept=".csv" />
        <button id="listBtn" class="secondary" disabled>Show List</button>
        <button id="exportBtn" class="secondary" disabled>Export List</button>
      </div>

      <div id="status" class="status"></div>

      <div class="mode-selection">
        <button id="modeSeq" class="mode-btn active">Sequential Mode</button>
        <button id="modeShuf" class="mode-btn">Shuffle Mode</button>
      </div>

      <div class="mode-selection">
        <button id="lenStd" class="mode-btn active">Standard</button>
        <button id="lenInf" class="mode-btn">Infinite</button>
      </div>
    </div>

    <div id="game" class="game">
      <div class="street-container">
        <div id="street" class="street"></div>
      </div>
      <div id="grid" class="grid"></div>
      <div class="footer">
        <div id="progress"></div>
        <div id="accuracy"></div>
      </div>
    </div>

    <!-- Summary Screen -->
    <div id="summaryPanel" class="summary-panel">
      <div class="summary-title">Performance Review</div>
      <div id="summaryTier" class="summary-tier"></div>
      
      <div class="summary-stats">
        <div class="stat-card">
          <span id="summaryAccuracy" class="stat-val">0%</span>
          <span class="stat-label">Accuracy</span>
        </div>
        <div class="stat-card">
          <span id="summaryCompleted" class="stat-val">0/0</span>
          <span class="stat-label">Completed</span>
        </div>
      </div>

      <div class="summary-actions">
        <button id="viewErrorsBtn" class="secondary" style="margin-bottom: 8px; display: none;">View Error Report</button>
        <div style="height: 40px;"></div>
        <button id="retryBtn" class="primary">Try Again</button>
        <button id="finishBtn" class="secondary">Back to Setup</button>
      </div>

    </div>

    <div class="action-row">
      <button id="startBtn" class="primary" disabled>Start</button>
      <button id="stopBtn">Stop</button>
    </div>
  </div>

  <div id="overlay" class="overlay">
    <div class="modal">
      <div class="modal-header">
        <span id="modalTitle">Street / Number Pairs</span>
        <div class="modal-header-actions">
          <button id="toggleEdit" class="icon-btn" title="Edit list">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
          </button>
          <span id="closeModal" class="close" title="Close">‚úï</span>
        </div>
      </div>
      <div class="modal-columns" id="modalCols">
        <div class="col-header" id="sortStreet">
          Street <span class="sort-icon" id="iconStreet"></span>
        </div>
        <div class="col-header" id="sortNumber">
          Number <span class="sort-icon" id="iconNumber"></span>
        </div>
      </div>
      <div id="modalContent" class="modal-content"></div>
      <div id="modalFooter" class="modal-footer">
        <button id="addRowBtn" class="secondary" style="border-style: dashed">+ Add Row</button>
        <button id="saveEdits" class="primary">Save Changes</button>
      </div>
    </div>
  </div>

  <script>
    let originalPairs = []; 
    let displayPairs = [];  
    let activeSequence = []; 
    
    // Tracking for statistics
    let streetStats = {}; // { streetName: { attempts: 0, correct: 0, wrongAnswers: [] } }

    let currentIndex = 0;   
    let attempts = 0;
    let correct = 0;
    let totalCompleted = 0;
    let locked = false;
    let isEditing = false;
    let moveTimer = null;
    let sortState = { key: null, dir: null };
    let draggedItemIdx = null;
    let gameMode = 'sequential'; 
    let gameLength = 'standard';

    const setupArea = document.getElementById('setupArea');
    const fileInput = document.getElementById('fileInput');
    const generateBtn = document.getElementById('generateBtn');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const listBtn = document.getElementById('listBtn');
    const exportBtn = document.getElementById('exportBtn');
    const statusEl = document.getElementById('status');
    const gameEl = document.getElementById('game');
    const streetEl = document.getElementById('street');
    const gridEl = document.getElementById('grid');
    const progressEl = document.getElementById('progress');
    const accuracyEl = document.getElementById('accuracy');
    const overlay = document.getElementById('overlay');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    const modalFooter = document.getElementById('modalFooter');
    const modalCols = document.getElementById('modalCols');
    const closeModal = document.getElementById('closeModal');
    const toggleEditBtn = document.getElementById('toggleEdit');
    const saveEditsBtn = document.getElementById('saveEdits');
    const addRowBtn = document.getElementById('addRowBtn');
    const modeSeqBtn = document.getElementById('modeSeq');
    const modeShufBtn = document.getElementById('modeShuf');
    const lenStdBtn = document.getElementById('lenStd');
    const lenInfBtn = document.getElementById('lenInf');
    
    const summaryPanel = document.getElementById('summaryPanel');
    const summaryTier = document.getElementById('summaryTier');
    const summaryAccuracy = document.getElementById('summaryAccuracy');
    const summaryCompleted = document.getElementById('summaryCompleted');
    const viewErrorsBtn = document.getElementById('viewErrorsBtn');
    const retryBtn = document.getElementById('retryBtn');
    const finishBtn = document.getElementById('finishBtn');

    const sortStreetBtn = document.getElementById('sortStreet');
    const sortNumberBtn = document.getElementById('sortNumber');
    const iconStreet = document.getElementById('iconStreet');
    const iconNumber = document.getElementById('iconNumber');

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function ensureAudio() { if (audioCtx.state === 'suspended') audioCtx.resume(); }

    function playWrongSound() {
      ensureAudio();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'square'; o.frequency.value = 180; g.gain.value = 0.1;
      o.connect(g).connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + 0.2);
    }

    function playSuccessSound() {
      ensureAudio();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(440, audioCtx.currentTime);
      o.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
      g.gain.value = 0.1;
      o.connect(g).connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + 0.2);
    }

    fileInput.addEventListener('change', handleFile);
    generateBtn.addEventListener('click', generateRandomData);
    startBtn.addEventListener('click', startGame);
    
    // Conditional Stop Logic
    stopBtn.addEventListener('click', () => {
      if (attempts === 0) {
        backToSetup();
      } else {
        showSummary();
      }
    });

    listBtn.addEventListener('click', openModal);
    exportBtn.addEventListener('click', exportList);
    closeModal.addEventListener('click', closeModalFn);
    toggleEditBtn.addEventListener('click', toggleEditMode);
    saveEditsBtn.addEventListener('click', saveEdits);
    addRowBtn.addEventListener('click', addNewRow);
    overlay.addEventListener('click', e => { if (e.target === overlay) closeModalFn(); });

    modeSeqBtn.addEventListener('click', () => setMode('sequential'));
    modeShufBtn.addEventListener('click', () => setMode('shuffle'));
    lenStdBtn.addEventListener('click', () => setLength('standard'));
    lenInfBtn.addEventListener('click', () => setLength('infinite'));

    sortStreetBtn.addEventListener('click', () => !isEditing && handleSort('street'));
    sortNumberBtn.addEventListener('click', () => !isEditing && handleSort('number'));

    viewErrorsBtn.addEventListener('click', openErrorsModal);
    retryBtn.addEventListener('click', startGame);
    finishBtn.addEventListener('click', backToSetup);

    function setMode(mode) {
      gameMode = mode;
      modeSeqBtn.classList.toggle('active', mode === 'sequential');
      modeShufBtn.classList.toggle('active', mode === 'shuffle');
    }

    function setLength(len) {
      gameLength = len;
      lenStdBtn.classList.toggle('active', len === 'standard');
      lenInfBtn.classList.toggle('active', len === 'infinite');
    }

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => parseCSV(reader.result);
      reader.readAsText(file);
    }

    function parseCSV(text) {
      const lines = text.split(/\n/).slice(1);
      originalPairs = [];
      for (const line of lines) {
        if (!line.trim()) continue;
        const cols = line.split(',');
        if (cols.length < 2) continue;
        const street = cols[0].trim();
        const number = cols[1].trim();
        if (street && number) originalPairs.push({ street, number });
      }
      if (originalPairs.length) {
        statusEl.textContent = `Loaded ${originalPairs.length} pairs.`;
        enableControls();
      } else {
        statusEl.textContent = 'No valid rows found.';
        disableControls();
      }
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function generateRandomData() {
      const firstWords = ['Oak','Pine','Maple','Cedar','Willow','Ash','Birch','Elm','Hazel','Rowan','King','Queen','Victoria','Albert','Regent','Sunny','Green','Meadow','River','Hill','Valley','Forest','Park','Garden'];
      const secondWords = ['Street','Avenue','Road','Close','Drive','Lane','Way','Crescent','Place','Court'];
      const numbers = ['1','2','3','4','5','6','670'];
      const usedNames = new Set();
      const tempPairs = [];
      
      while (tempPairs.length < 20) {
        const name = `${firstWords[Math.floor(Math.random() * firstWords.length)]} ${secondWords[Math.floor(Math.random() * secondWords.length)]}`;
        if (usedNames.has(name)) continue;
        usedNames.add(name);
        const number = numbers[tempPairs.length % numbers.length];
        tempPairs.push({ street: name, number });
      }

      originalPairs = [...tempPairs].sort((a, b) => a.street.localeCompare(b.street));
      fileInput.value = '';
      statusEl.textContent = 'Generated 20 pairs.';
      enableControls();
    }

    function enableControls() {
      startBtn.disabled = false;
      listBtn.disabled = false;
      exportBtn.disabled = false;
      sortState = { key: null, dir: null };
      displayPairs = [...originalPairs];
    }

    function disableControls() {
      startBtn.disabled = true;
      listBtn.disabled = true;
      exportBtn.disabled = true;
    }

    function handleSort(key) {
      if (sortState.key === key) {
        if (sortState.dir === 'asc') sortState.dir = 'desc';
        else if (sortState.dir === 'desc') { sortState.key = null; sortState.dir = null; }
      } else {
        sortState.key = key; sortState.dir = 'asc';
      }
      applySort();
      renderModalList();
    }

    function applySort() {
      if (!sortState.key) {
        displayPairs = [...originalPairs];
      } else {
        displayPairs.sort((a, b) => {
          let valA = a[sortState.key];
          let valB = b[sortState.key];
          const numA = parseFloat(valA);
          const numB = parseFloat(valB);
          if (!isNaN(numA) && !isNaN(numB)) { valA = numA; valB = numB; }
          if (valA < valB) return sortState.dir === 'asc' ? -1 : 1;
          if (valA > valB) return sortState.dir === 'asc' ? 1 : -1;
          return 0;
        });
      }
    }

    function toggleEditMode() {
      isEditing = !isEditing;
      toggleEditBtn.classList.toggle('active', isEditing);
      modalFooter.classList.toggle('visible', isEditing);
      modalCols.style.display = isEditing ? 'none' : 'flex';
      
      if (!isEditing) {
        applySort();
      } else {
        displayPairs = [...originalPairs];
      }
      renderModalList();
    }

    function addNewRow() {
        displayPairs.push({ street: '', number: '' });
        renderModalList();
        modalContent.scrollTop = modalContent.scrollHeight;
    }

    function removeRow(idx) {
        displayPairs.splice(idx, 1);
        renderModalList();
    }

    function saveEdits() {
      const rows = modalContent.querySelectorAll('.pair-row');
      const newPairs = [];
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (inputs.length === 2) {
          const street = inputs[0].value.trim();
          const number = inputs[1].value.trim();
          if (street && number) newPairs.push({ street, number });
        }
      });
      
      if (newPairs.length > 0) {
        originalPairs = newPairs;
        statusEl.textContent = `Updated list with ${originalPairs.length} pairs.`;
        toggleEditMode();
      }
    }

    function handleDragStart(e, idx) {
      draggedItemIdx = idx;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e, idx) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const target = e.currentTarget;
      if (idx === draggedItemIdx) return;
      const rect = target.getBoundingClientRect();
      const midpoint = rect.top + rect.height / 2;
      target.classList.remove('drag-over-top', 'drag-over-bottom');
      if (e.clientY < midpoint) target.classList.add('drag-over-top');
      else target.classList.add('drag-over-bottom');
    }

    function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over-top', 'drag-over-bottom'); }

    function handleDrop(e, idx) {
      e.preventDefault();
      const target = e.currentTarget;
      const rect = target.getBoundingClientRect();
      const midpoint = rect.top + rect.height / 2;
      const isAbove = e.clientY < midpoint;
      target.classList.remove('drag-over-top', 'drag-over-bottom');
      if (draggedItemIdx === null) return;

      const rows = Array.from(modalContent.querySelectorAll('.pair-row'));
      const currentData = rows.map(row => {
        const inputs = row.querySelectorAll('input');
        return { street: inputs[0].value, number: inputs[1].value };
      });

      const movedItem = currentData.splice(draggedItemIdx, 1)[0];
      let insertIdx = idx;
      if (!isAbove) insertIdx++;
      if (draggedItemIdx < insertIdx) insertIdx--;
      currentData.splice(insertIdx, 0, movedItem);
      displayPairs = currentData;
      renderModalList();
    }

    function renderModalList() {
      modalTitle.textContent = "Street / Number Pairs";
      toggleEditBtn.style.display = 'flex';
      modalContent.innerHTML = '';
      displayPairs.forEach((p, idx) => {
        const row = document.createElement('div');
        row.className = 'pair-row';
        if (isEditing) {
          row.draggable = true;
          row.addEventListener('dragstart', (e) => handleDragStart(e, idx));
          row.addEventListener('dragover', (e) => handleDragOver(e, idx));
          row.addEventListener('dragleave', handleDragLeave);
          row.addEventListener('drop', (e) => handleDrop(e, idx));
          row.addEventListener('dragend', (e) => {
            e.target.classList.remove('dragging');
            Array.from(modalContent.children).forEach(c => c.classList.remove('drag-over-top', 'drag-over-bottom'));
          });
          row.innerHTML = `
            <div class="drag-handle" title="Drag to reorder">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="16" y2="6"></line><line x1="8" y1="12" x2="16" y2="12"></line><line x1="8" y1="18" x2="16" y2="18"></line></svg>
            </div>
            <input type="text" value="${p.street.replace(/"/g, '&quot;')}" placeholder="Street">
            <input type="text" value="${p.number.replace(/"/g, '&quot;')}" placeholder="No.">
            <button class="icon-btn delete" onclick="removeRow(${idx})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
          `;
        } else {
          row.innerHTML = `<span>${p.street}</span><span>${p.number}</span>`;
        }
        modalContent.appendChild(row);
      });
      if (!isEditing) {
        iconStreet.textContent = sortState.key === 'street' ? (sortState.dir === 'asc' ? '‚ñ≤' : '‚ñº') : '';
        iconNumber.textContent = sortState.key === 'number' ? (sortState.dir === 'asc' ? '‚ñ≤' : '‚ñº') : '';
      }
    }

    function openModal() {
      isEditing = false;
      toggleEditBtn.classList.remove('active');
      modalFooter.classList.remove('visible');
      modalCols.style.display = 'flex';
      applySort(); 
      renderModalList();
      overlay.style.display = 'flex';
    }

    function openErrorsModal() {
      modalTitle.textContent = "Errors Report";
      toggleEditBtn.style.display = 'none';
      modalCols.style.display = 'none';
      modalFooter.classList.remove('visible');
      
      const report = [];
      for (const [street, stats] of Object.entries(streetStats)) {
        if (stats.wrongAnswers.length > 0) {
          const pair = originalPairs.find(p => p.street === street);
          const rate = Math.round((stats.correct / stats.attempts) * 100);
          report.push({
            street,
            wrongAnswers: stats.wrongAnswers,
            correctAnswer: pair ? pair.number : '?',
            successRate: rate,
            wrongCount: stats.wrongAnswers.length
          });
        }
      }

      report.sort((a, b) => b.wrongCount - a.wrongCount);

      const table = document.createElement('table');
      table.className = 'error-table';
      table.innerHTML = `
        <thead>
          <tr>
            <th>Street Name</th>
            <th>Mistakes</th>
            <th>Correct</th>
            <th>Success</th>
          </tr>
        </thead>
        <tbody>
          ${report.map(r => `
            <tr>
              <td><strong>${r.street}</strong></td>
              <td>${r.wrongAnswers.map(w => `<span class="badge-wrong">${w}</span>`).join('')}</td>
              <td>${r.correctAnswer}</td>
              <td class="${r.successRate < 50 ? 'text-fail' : 'text-success'}">${r.successRate}%</td>
            </tr>
          `).join('')}
        </tbody>
      `;

      modalContent.innerHTML = '';
      if (report.length === 0) {
        modalContent.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--muted);">No errors recorded! Perfect run.</div>';
      } else {
        modalContent.appendChild(table);
      }
      
      overlay.style.display = 'flex';
    }

    function closeModalFn() { overlay.style.display = 'none'; }

    function generateSequence() {
      const indices = originalPairs.map((_, i) => i);
      if (gameMode === 'shuffle') {
        shuffleArray(indices);
      }
      activeSequence = indices;
    }

    function startGame() {
      if (originalPairs.length === 0) return;
      currentIndex = 0;
      attempts = 0;
      correct = 0;
      totalCompleted = 0;
      streetStats = {}; 
      
      generateSequence();
      
      startBtn.textContent = 'Restart';
      startBtn.style.display = 'block';
      stopBtn.style.display = 'block';
      setupArea.classList.add('hidden');
      summaryPanel.style.display = 'none';
      gameEl.style.display = 'block';
      loadRound();
    }

    function showSummary() {
      locked = true;
      clearTimeout(moveTimer);
      
      const pct = attempts ? Math.round((correct / attempts) * 100) : 0;
      
      let tierHtml = "";
      if (pct < 20) tierHtml = "<strong>üó∫Ô∏è Tourist</strong><br><small>Just visiting Greendale.</small>";
      else if (pct < 40) tierHtml = "<strong>‚úâÔ∏è New Recruit</strong><br><small>Finding your feet in the village.</small>";
      else if (pct < 60) tierHtml = "<strong>üö∂ The Regular</strong><br><small>Reliable and efficient, just like Pat.</small>";
      else if (pct < 80) tierHtml = "<strong>üöö Rising Star</strong><br><small>The route is becoming second nature.</small>";
      else if (pct < 100) tierHtml = "<strong>ü§ñ Human GPS</strong><br><small>Operating at near-superhuman levels.</small>";
      else tierHtml = "<strong>üíØ Local Legend </strong><br><small>You know the neighborhood better than anyone!</small>";

      summaryTier.innerHTML = tierHtml;
      summaryAccuracy.textContent = `${pct}%`;
      summaryCompleted.textContent = `${totalCompleted} Rounds`;
      
      const hasErrors = Object.values(streetStats).some(s => s.wrongAnswers.length > 0);
      viewErrorsBtn.style.display = hasErrors ? 'block' : 'none';

      gameEl.style.display = 'none';
      summaryPanel.style.display = 'block';
      startBtn.style.display = 'none';
      stopBtn.style.display = 'none';
    }

    function backToSetup() {
      currentIndex = 0;
      attempts = 0;
      correct = 0;
      totalCompleted = 0;
      locked = false;
      startBtn.textContent = 'Start';
      startBtn.style.display = 'block';
      stopBtn.style.display = 'none';
      setupArea.classList.remove('hidden');
      gameEl.style.display = 'none';
      summaryPanel.style.display = 'none';
      streetEl.classList.remove('moving');
    }

    function loadRound() {
      locked = false;
      clearTimeout(moveTimer);
      streetEl.classList.remove('moving');
      
      const pairIdx = activeSequence[currentIndex];
      const pair = originalPairs[pairIdx];
      
      streetEl.textContent = pair.street;
      gridEl.innerHTML = '';

      moveTimer = setTimeout(() => {
        if (!locked) { streetEl.classList.add('moving'); }
      }, 5000);

      const uniqueNumbers = [...new Set(originalPairs.map(p => p.number))].sort((a, b) => {
        const na = parseFloat(a), nb = parseFloat(b);
        return (isNaN(na) || isNaN(nb)) ? a.localeCompare(b) : na - nb;
      });

      uniqueNumbers.forEach(num => {
        const btn = document.createElement('button');
        btn.textContent = num;
        btn.onclick = () => handleGuess(btn, num === pair.number);
        gridEl.appendChild(btn);
      });

      updateFooter();
    }

    function handleGuess(button, isCorrect) {
      if (locked) return;
      locked = true;
      attempts++;
      clearTimeout(moveTimer);
      streetEl.classList.remove('moving');

      const pairIdx = activeSequence[currentIndex];
      const pair = originalPairs[pairIdx];
      const correctNumber = pair.number;

      if (!streetStats[pair.street]) {
        streetStats[pair.street] = { attempts: 0, correct: 0, wrongAnswers: [] };
      }
      streetStats[pair.street].attempts++;

      if (isCorrect) {
        correct++;
        streetStats[pair.street].correct++;
        playSuccessSound();
        button.classList.add('correct');
        setTimeout(nextRound, 500);
      } else {
        streetStats[pair.street].wrongAnswers.push(button.textContent);
        playWrongSound();
        button.classList.add('wrong');
        const buttons = Array.from(gridEl.children);
        const correctBtn = buttons.find(b => b.textContent === correctNumber);
        if (correctBtn) correctBtn.classList.add('highlight');
        setTimeout(nextRound, 1000);
      }
      updateFooter();
    }

    function nextRound() {
      currentIndex++;
      totalCompleted++;

      if (currentIndex >= originalPairs.length) {
        if (gameLength === 'infinite') {
            currentIndex = 0;
            if (gameMode === 'shuffle') generateSequence();
            loadRound();
        } else {
            showSummary(); 
        }
      } else {
        loadRound();
      }
    }

    function updateFooter() {
      if (gameLength === 'infinite') {
        progressEl.textContent = `Completed: ${totalCompleted}`;
      } else {
        progressEl.textContent = `Street ${currentIndex + 1} / ${originalPairs.length}`;
      }
      const pct = attempts ? Math.round((correct / attempts) * 100) : 100;
      accuracyEl.textContent = `Accuracy: ${pct}%`;
    }

    function exportList() {
      if (!originalPairs.length) return;
      const header = 'Street,Round Number\n';
      const rows = originalPairs.map(p => `${p.street},${p.number}`).join('\n');
      const blob = new Blob([header + rows], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'street-number-list.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>